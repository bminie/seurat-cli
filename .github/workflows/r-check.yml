name: R Syntax Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  syntax-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3'
    
    - name: Install dependencies
      run: |
        install.packages(c("optparse", "lintr"))
      shell: Rscript {0}
    
    - name: Check R syntax
      run: |
        # Check each R file for syntax errors
        files <- list.files(pattern = "\\.R$", recursive = TRUE, full.names = TRUE)
        errors <- c()
        
        for (f in files) {
          tryCatch({
            parse(f)
            message(paste("✓", f))
          }, error = function(e) {
            errors <<- c(errors, paste(f, ":", e$message))
            message(paste("✗", f, "-", e$message))
          })
        }
        
        if (length(errors) > 0) {
          stop(paste("Syntax errors found:\n", paste(errors, collapse = "\n")))
        }
        
        message("\nAll R files have valid syntax!")
      shell: Rscript {0}
    
    - name: Lint R code
      run: |
        library(lintr)
        
        # Custom linters - less strict for scripts
        linters <- linters_with_defaults(
          line_length_linter = line_length_linter(120),
          object_name_linter = NULL,  # Allow flexible naming
          commented_code_linter = NULL  # Allow commented examples
        )
        
        files <- list.files(pattern = "\\.R$", recursive = TRUE, full.names = TRUE)
        
        all_lints <- list()
        for (f in files) {
          lints <- lint(f, linters = linters)
          if (length(lints) > 0) {
            all_lints[[f]] <- lints
          }
        }
        
        if (length(all_lints) > 0) {
          for (f in names(all_lints)) {
            message(paste("\n", f, ":"))
            print(all_lints[[f]])
          }
          message("\nLint warnings found (non-blocking)")
        } else {
          message("No lint issues found!")
        }
      shell: Rscript {0}
      continue-on-error: true  # Lint warnings don't fail the build

  help-check:
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3'
    
    - name: Install optparse
      run: |
        install.packages("optparse")
      shell: Rscript {0}
    
    - name: Verify --help works for all scripts
      run: |
        scripts <- list.files("scripts", pattern = "\\.R$", full.names = TRUE)
        
        for (script in scripts) {
          message(paste("\nTesting:", script))
          
          # Source the common utilities first
          result <- tryCatch({
            # Just check that optparse can parse the arguments
            cmd <- paste("Rscript", script, "--help")
            system(cmd, intern = TRUE)
            message(paste("  ✓ --help works"))
            TRUE
          }, error = function(e) {
            message(paste("  ✗ Error:", e$message))
            FALSE
          })
        }
      shell: Rscript {0}
