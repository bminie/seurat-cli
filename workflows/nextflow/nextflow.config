/*
 * =============================================================================
 * Seurat CLI Nextflow Pipeline Configuration
 * =============================================================================
 */

// -----------------------------------------------------------------------------
// Default Parameters
// -----------------------------------------------------------------------------

params {
    // Workflow selection
    workflow = "sctransform"

    // Input/Output
    input = null
    input_list = null
    outdir = "results"
    scripts_dir = "${projectDir}/../../scripts"

    // Common
    species = "human"
    threads = 4
    demo = false

    // Basic analysis
    basic_min_features = 200
    basic_max_features = 2500
    basic_max_mt = 5
    basic_resolution = 0.5
    basic_dims = "1:10"

    // SCTransform
    sct_n_features = 3000
    sct_resolution = 0.5
    sct_dims = "1:30"
    sct_vars_to_regress = ""

    // Integration
    int_method = "CCAIntegration"
    int_normalization = "LogNormalize"
    int_resolution = 0.5
    int_dims = "1:30"
    int_sample_names = ""
    int_conditions = ""

    // DE
    de_mode = "all_markers"
    de_test = "wilcox"
    de_logfc = 0.25
    de_min_pct = 0.1

    // Cell cycle
    cc_regress = false
    cc_regress_difference = false

    // Visualization
    viz_reduction = "umap"
    viz_features = ""

    // Max resource options (use integer values for memory in GB, time in hours)
    max_memory = 16.GB
    max_cpus = 8
    max_time = 24.h
}

// -----------------------------------------------------------------------------
// Profiles
// -----------------------------------------------------------------------------

profiles {

    // Standard local execution
    standard {
        process.executor = 'local'
    }

    // Demo profile - uses built-in datasets
    demo {
        params.demo = true
        params.outdir = "demo_results"
        params.workflow = "sctransform"
    }

    // Docker profile
    docker {
        docker.enabled = true
        docker.userEmulation = true
        // Use Rocker image with Seurat
        process.container = 'satijalab/seurat:latest'
    }

    // Singularity profile
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        process.container = 'docker://satijalab/seurat:latest'
    }

    // SLURM cluster profile
    slurm {
        process.executor = 'slurm'
        process.queue = 'normal'
        process.clusterOptions = '--account=your_account'
        process.time = '4h'
        process.memory = '16 GB'
        process.cpus = 4
    }

    // PBS/Torque cluster profile
    pbs {
        process.executor = 'pbs'
        process.queue = 'batch'
        process.time = '4h'
        process.memory = '16 GB'
        process.cpus = 4
    }

    // AWS Batch profile
    awsbatch {
        process.executor = 'awsbatch'
        process.queue = 'your-batch-queue'
        aws.region = 'us-east-1'
        aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws'
    }

    // Test profile - minimal resources for CI/local testing
    test {
        params.demo = true
        params.outdir = "test_results"
        params.workflow = "sctransform"
        params.threads = 2
        // Reduce memory for all processes to work on machines with limited memory
        process {
            cpus = 2
            memory = 4.GB
            time = 1.h
            // Override process-specific settings for low-memory environments
            withName: 'SCTRANSFORM' {
                memory = 4.GB
            }
            withName: 'INTEGRATION' {
                memory = 4.GB
            }
            withName: 'DIFFERENTIAL_EXPRESSION' {
                memory = 4.GB
            }
        }
    }
}

// -----------------------------------------------------------------------------
// Process Configuration
// -----------------------------------------------------------------------------

process {
    // Default resources
    cpus = { check_max(params.threads, 'cpus') }
    memory = { check_max('8 GB', 'memory') }
    time = { check_max('4h', 'time') }

    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'terminate' }
    maxRetries = 2

    // Process-specific resources
    withName: 'SCTRANSFORM' {
        memory = { check_max('6 GB', 'memory') }
        time = { check_max('2h', 'time') }
    }

    withName: 'INTEGRATION' {
        memory = { check_max('16 GB', 'memory') }
        time = { check_max('4h', 'time') }
    }

    withName: 'DIFFERENTIAL_EXPRESSION' {
        memory = { check_max('8 GB', 'memory') }
        time = { check_max('2h', 'time') }
    }
}

// -----------------------------------------------------------------------------
// Execution Reports
// -----------------------------------------------------------------------------

// Timeline report
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

// Execution report
report {
    enabled = true
    file = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

// Trace report
trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
}

// DAG visualization
dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/dag.svg"
    overwrite = true
}

// -----------------------------------------------------------------------------
// Helper Functions
// -----------------------------------------------------------------------------

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "WARNING: Max memory '${params.max_memory}' is not valid, using default"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "WARNING: Max time '${params.max_time}' is not valid, using default"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "WARNING: Max cpus '${params.max_cpus}' is not valid, using default"
            return obj
        }
    }
}

// -----------------------------------------------------------------------------
// Manifest
// -----------------------------------------------------------------------------

manifest {
    name = 'seurat-cli'
    author = 'bminie'
    description = 'Nextflow pipeline for Seurat scRNA-seq analysis'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
    mainScript = 'main.nf'
}
